{% extends 'studentside/base.html' %}

{% load static %}

{% block title %}Take Exam - {{ exam.title }}{% endblock %}

{% block header %}{{ exam.title }}{% endblock %}

{% block content %}
<div class="row"  data-exam-id="{{ exam.id }}">
    <div class="col-md-8 offset-md-2">
        <div class="alert alert-info">
            <strong>Time left: <span id="time-left">Loading...</span></strong>
        </div>

        <!-- Camera on top right of the webpage -->
        <div id="camera-container" style="position: fixed; top: 10px; right: 10px; width: 160px; height: 120px; border: 2px solid #000; z-index: 1000; background-color: #000; overflow: hidden;">
            <img id="camera-feed" src="{% url 'video' %}" width="160" height="120" 
                 alt="Live Camera Feed" style="border: 2px solid red; border-radius: 8px; object-fit: cover;">
        </div>

        <!-- Exam Form -->
        <form method="post" id="exam-form" action="{% url 'student-submit-exam' %}">
            {% csrf_token %}
            <input type="hidden" name="event_log" id="event-log-input">
            <input type="hidden" name="exam_id" value="{{ exam.id }}">
            
            <div class="card">
                <div class="card-header">
                    <h4>Exam Questions</h4>
                </div>
                <div class="card-body">
                    {% for question in questions %}
                    <div class="mb-4">
                        <h5>{{ question.question_number }}</h5>
                        <p>{{ question.question_text }}</p>
                        
                        {% if question.question_type == 'numerical' %}
                            <input type="text" name="answer_{{ question.id }}" class="form-control" required>
                            
                        {% elif question.question_type == 'true_false' %}
                            <div class="form-check">
                                <input type="radio" name="answer_{{ question.id }}" value="True" class="form-check-input" id="q{{ question.id }}_true" required>
                                <label class="form-check-label" for="q{{ question.id }}_true">True</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" name="answer_{{ question.id }}" value="False" class="form-check-input" id="q{{ question.id }}_false" required>
                                <label class="form-check-label" for="q{{ question.id }}_false">False</label>
                            </div>
                            
                        {% elif question.question_type == 'mcq_one' %}
                            {% for choice in question.choices %}
                            <div class="form-check">
                                <input type="radio" name="answer_{{ question.id }}" value="{{ choice }}" class="form-check-input" id="q{{ question.id }}_{{ forloop.counter }}" required>
                                <label class="form-check-label" for="q{{ question.id }}_{{ forloop.counter }}">{{ choice }}</label>
                            </div>
                            {% endfor %}
                            
                        {% elif question.question_type == 'mcq_multi' %}
                            {% for choice in question.choices %}
                            <div class="form-check">
                                <input type="checkbox" name="answer_{{ question.id }}" value="{{ choice }}" class="form-check-input" id="q{{ question.id }}_{{ forloop.counter }}">
                                <label class="form-check-label" for="q{{ question.id }}_{{ forloop.counter }}">{{ choice }}</label>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Submit Exam</button>
            </div>
        </form>
    </div>
</div>

<!-- Warning Overlay (initially hidden) -->
<div id="warning-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 0, 0, 0.95); z-index: 9999; color: white; text-align: center; padding-top: 20%;">
    <h1>⚠️ VIOLATION DETECTED ⚠️</h1>
    <h3>You attempted to access developer tools or right-click menu.</h3>
    <p style="font-size: 18px;">This exam session has been flagged for review.</p>
    <p style="font-size: 18px;">Your attempt has been logged with a timestamp.</p>
    <p style="font-size: 16px; margin-top: 30px;">This page will remain blocked for security purposes.</p>
    <p style="font-size: 14px; color: #ffcccc; margin-top: 50px;">If this was accidental, please contact your instructor.</p>
</div>

<style>
    .blocked {
        pointer-events: none;
        user-select: none;
        filter: blur(10px);
    }
</style>

<script>
    // Pass Django variables to JavaScript
    window.examConfig = {
        examId: {{ exam.id }},
        examDurationMinutes: {{ exam_duration }},  // Duration in minutes from Django
    };
</script>

<script src="{% static 'studentside/js/test_exam.js' %}"></script>

{% endblock %}